# TODO — PartyQuiz

> **Generated by:** Developer Agent (Phase 4)
> **Generated from:** specs/implementation-plan.md, specs/architecture.md, specs/prd.md, specs/decisions/*.md
> **Date:** 2026-02-24
> **Status:** In Progress
>
> This file is the spec-driven task checklist for Phase 4 implementation.
> Every item traces to an approved spec artifact. Do not add tasks that
> lack spec traceability. If new work is discovered, update the spec first
> (Power Inversion — Article IV).

---

## Extended Table of Contents

| Section | Summary |
|---------|---------|
| Tech Manifest | 28 pinned technology choices |
| Data Layer | PostgreSQL (SQLModel) + Redis + JSON column pattern |
| Target Directory Structure | New and modified files annotated |
| Canonical Code Patterns | 5 patterns: SQLModel session, LiteLLM call, Svelte Runes, @theme tokens, error shape |
| Dependency Graph | 47 tasks, validated DAG |
| Implementation Checklist | M0–M6 with full task details |
| Traceability Matrix | 35 PRD stories → tasks |
| NFR Constraint Checklist | 14 NFRs mapped to tasks |
| Active ADR Constraints | ADR-001 through ADR-006 |
| Roadmap Articles in Effect | Articles I–XII |
| Agent Permissions | Developer scope |
| Progress Summary | Running counts |

---

## Tech Manifest

> Extracted from `specs/architecture.md` §Technology Stack. No unpinned entries allowed.

| Dimension | Choice | Version | Lockfile | Source |
|-----------|--------|---------|----------|--------|
| Runtime (BE) | Python | 3.13 | Pipfile.lock | architecture.md §Tech Stack |
| API Framework | FastAPI | `*` (latest) | Pipfile.lock | architecture.md §Tech Stack |
| WebSocket | python-socketio | `*` (latest) | Pipfile.lock | architecture.md §Tech Stack |
| ORM | SQLModel | `^0.0.24` | Pipfile.lock | architecture.md §Tech Stack, ADR-001 |
| Async PG Driver | asyncpg | `*` (latest) | Pipfile.lock | architecture.md §Tech Stack |
| Sync PG Driver | psycopg2 | `*` (latest) | Pipfile.lock | architecture.md §Tech Stack |
| Migrations | Alembic | `*` (latest) | Pipfile.lock | architecture.md §Tech Stack |
| Cache / Queue | Redis (redis-py) | `*` (latest) | Pipfile.lock | architecture.md §Tech Stack |
| Job Queue | arq | `*` (latest) | Pipfile.lock | architecture.md §Tech Stack |
| Validation | Pydantic + pydantic-settings | v2 | Pipfile.lock | architecture.md §Tech Stack |
| Auth (JWT) | python-jose | `*` (latest) | Pipfile.lock | architecture.md §Tech Stack |
| Auth (hash) | passlib + argon2-cffi | `*` (latest) | Pipfile.lock | architecture.md §Tech Stack |
| Auth (OAuth) | authlib | `*` (latest) | Pipfile.lock | architecture.md §Tech Stack |
| Auth (FIDO2) | webauthn | `==1.*` (pinned) | Pipfile.lock | architecture.md §Tech Stack |
| Auth (TOTP) | pyotp | `*` (latest) | Pipfile.lock | architecture.md §Tech Stack |
| LLM Gateway | LiteLLM | `^1.81` | Pipfile.lock | architecture.md §Tech Stack, ADR-002 [Context7: litellm@1.81.13] |
| Metrics | prometheus-fastapi-instrumentator | `*` (latest) | Pipfile.lock | architecture.md §Tech Stack, ADR-006 |
| Error Tracking | sentry-sdk | `*` (latest) | Pipfile.lock | architecture.md §Tech Stack |
| Language (FE) | TypeScript | `^5` | pnpm-lock.yaml | architecture.md §Tech Stack |
| Framework (FE) | SvelteKit | `^2.47.3` | pnpm-lock.yaml | architecture.md §Tech Stack [Context7: svelte_dev_kit] |
| UI Runtime | Svelte | 4 → 5 Runes (interleave) | pnpm-lock.yaml | architecture.md §Tech Stack, ADR-004 |
| Styling | TailwindCSS | 4 (`@theme`) | pnpm-lock.yaml | architecture.md §Tech Stack, ADR-003 [Context7: tailwindlabs/tailwindcss.com] |
| Font | @fontsource/outfit | `^5` | pnpm-lock.yaml | architecture.md §Tech Stack |
| Build | Vite | `^6` | pnpm-lock.yaml | architecture.md §Tech Stack |
| Test Runner (BE) | pytest + pytest-asyncio | `*` | Pipfile.lock | architecture.md §Commands |
| Test Runner (FE unit) | Vitest | bundled with SvelteKit | pnpm-lock.yaml | architecture.md §Testing |
| Test Runner (FE E2E) | Playwright | `*` | pnpm-lock.yaml | architecture.md §Testing |
| Proxy | Caddy | 2 | docker-compose.yml | architecture.md §Tech Stack |
| Database | PostgreSQL | 14 | docker-compose.yml | architecture.md §Tech Stack |

---

## Data Layer

| Concern | Declaration | Source |
|---------|-------------|--------|
| **Persistence model** | PostgreSQL 14 via SQLModel async sessions (replacing ormar). All DB entities are `SQLModel` with `table=True`. | architecture.md §Data Model, ADR-001 |
| **Game session state** | Redis-only (JSON blobs, `PlayGame` / `GamePlayer` Pydantic BaseModels, TTL 2h). Not in PostgreSQL. | architecture.md §Data Model |
| **Phase gate state** | YAML frontmatter `approved_by` + `approval_date` fields; `.jumpstart/state/state.json` | architecture.md §Linked Data |
| **Artifact versioning** | Git tag (`pre-sqlmodel-migration`) created in M0-T01 as rollback point | specs/implementation-plan.md §M0-T01 |
| **Structured data** | Dependency graph in `.jumpstart/spec-graph.json`; QA log at `specs/qa-log.md` (append-only) | config.yaml §dependency_graph |
| **State mutation rules** | Insights files and QA log are append-only. Specs are immutable after approval (Power Inversion). Redis game state is mutable, TTL-bounded. | roadmap.md §Article IV |
| **open_ended question data** | `QuizQuestion.questions` is a **JSON column** in PostgreSQL. Adding `open_ended` type + `llm_rubric` field to the Pydantic model requires **no SQL schema migration** — only a comment-record Alembic revision. | architecture.md §Data Model, INS-007 |

---

## Target Directory Structure

```
classquiz/
  llm/                  ← NEW: LLM Evaluation Module (Library-First, Article I)
    __init__.py         ← Public API: evaluate_answer(), LLMUnavailableError, Verdict
    models.py           ← Verdict type, EvaluationRequest/Response
    health.py           ← LLM provider health check function
  db/
    models.py           ← MODIFIED: ormar → SQLModel; open_ended QuizQuestion type added
    session.py          ← NEW: create_async_engine + async_sessionmaker + get_session()
  socket_server/
    __init__.py         ← MODIFIED: open_ended answer handling + llm_verdict socket events
    models.py           ← MODIFIED: open_ended game state types
  routers/
    utils.py            ← MODIFIED: add GET /api/v1/llm/health route
  config.py             ← MODIFIED: add LITELLM_* and LLM_* pydantic-settings fields
  __init__.py           ← MODIFIED: FastAPI lifespan context manager (replaces @app.on_event)
migrations/
  versions/
    NNN_add_open_ended_question_type.py  ← NEW: comment-record migration
prometheus/
  prometheus.yml        ← NEW: scrape config targeting api:8000/metrics
grafana/
  dashboards/
    partyquiz.json      ← NEW: pre-built Grafana dashboard

frontend/src/
  app.css               ← MODIFIED: @theme tokens + Outfit font + prefers-reduced-motion
  lib/
    components/
      ui/
        Button.svelte   ← NEW: Svelte 5 Runes, 4 variants, SPDX header
        Card.svelte     ← NEW: Svelte 5 Runes, SPDX header
      layout/
        Nav.svelte      ← NEW/REDESIGNED: global navigation, Svelte 5 Runes
      game/
        OpenEndedPlayer.svelte   ← NEW: E8 player text input + verdict feedback
        ManualReviewPanel.svelte ← NEW: E8 host manual review panel
    socket.ts           ← MODIFIED: reconnect logic (M2-T03)
  routes/
    +layout.svelte      ← MODIFIED: bg-void applied globally
    +page.svelte        ← MODIFIED: homepage redesign
    play/
      +page.svelte      ← MODIFIED: PIN entry runes + token styles
      game/             ← MODIFIED: lobby/question/leaderboard/results
    host/               ← MODIFIED: all host screens
    edit/               ← MODIFIED: editor layout + question cards
    dashboard/+page.svelte ← MODIFIED: bento grid design
    results/+page.svelte   ← MODIFIED: results summary
    settings/+page.svelte  ← MODIFIED: profile/settings

docker-compose.yml      ← MODIFIED: prometheus, grafana, ollama services added
.env.example            ← MODIFIED: LITELLM_*, LLM_*, PROMETHEUS_ENABLED added
```

---

## Canonical Code Patterns

### Pattern 1: SQLModel Async Session (BE)

**Mandate source:** ADR-001 — Replace ormar with SQLModel; architecture.md §Component: FastAPI API Layer

```python
# classquiz/db/session.py — canonical session factory
from sqlmodel.ext.asyncio.session import AsyncSession
from sqlalchemy.ext.asyncio import create_async_engine, async_sessionmaker
from classquiz.config import settings

engine = create_async_engine(settings.db_url, echo=False)
async_session_factory = async_sessionmaker(engine, class_=AsyncSession, expire_on_commit=False)

async def get_session() -> AsyncSession:
    async with async_session_factory() as session:
        yield session

# Usage in router:
# async def my_route(session: AsyncSession = Depends(get_session)):
#     result = await session.exec(select(User).where(User.email == email))
#     user = result.first()
```

**Anti-pattern:** Do NOT use `ormar.Model` subclasses, `await Model.objects.get()`, or `@app.on_event("startup")` for engine setup.

---

### Pattern 2: LiteLLM Evaluation Call (BE)

**Mandate source:** ADR-002 — LiteLLM gateway; architecture.md §Component: LLM Evaluation Module [Context7: litellm@1.81.13]

```python
# classquiz/llm/__init__.py — canonical LLM evaluation function
import asyncio
import json
import litellm
from classquiz.llm.models import Verdict, LLMUnavailableError
from classquiz.config import settings

async def evaluate_answer(question: str, answer: str, rubric: str | None = None) -> Verdict:
    prompt = f"Question: {question}\nAnswer: {answer}"
    if rubric:
        prompt += f"\nRubric: {rubric}"
    prompt += '\nRespond with JSON only: {"verdict": "correct"|"incorrect"|"partial"}'
    try:
        response = await asyncio.wait_for(
            litellm.acompletion(
                model=settings.litellm_model,
                api_base=settings.litellm_api_base,
                api_key=settings.litellm_api_key,
                messages=[{"role": "user", "content": prompt}],
                drop_params=True,
            ),
            timeout=settings.llm_timeout_seconds,
        )
        data = json.loads(response.choices[0].message.content)
        return data["verdict"]  # "correct" | "incorrect" | "partial"
    except (asyncio.TimeoutError, Exception) as exc:
        raise LLMUnavailableError(str(exc)) from exc
```

**Anti-pattern:** Do NOT import litellm in router files directly. Do NOT call `litellm.completion` (sync). Do NOT let exceptions propagate past the socket handler uncaught.

---

### Pattern 3: Svelte 5 Runes Component (FE)

**Mandate source:** ADR-004 — Svelte 4→5 Runes interleave; architecture.md §Component: SvelteKit Frontend [Context7: svelte_dev_kit]

```svelte
<!-- frontend/src/lib/components/ui/Button.svelte -->
<!-- SPDX-License-Identifier: MPL-2.0 -->
<script lang="ts">
  interface Props {
    variant?: 'primary' | 'secondary' | 'ghost' | 'danger';
    disabled?: boolean;
    onclick?: () => void;
  }
  let { variant = 'primary', disabled = false, onclick, children } = $props<Props>();

  const variantClasses: Record<string, string> = {
    primary:   'bg-accent-electric text-bg-void shadow-hard hover:translate-y-[-2px]',
    secondary: 'border-2 border-accent-electric text-accent-electric shadow-hard',
    ghost:     'text-white hover:text-accent-electric',
    danger:    'bg-accent-red text-white shadow-hard',
  };
</script>
<button
  class="px-6 py-3 font-display font-bold uppercase tracking-widest rounded-none transition-transform
         {variantClasses[variant]} {disabled ? 'opacity-50 cursor-not-allowed' : ''}"
  {disabled}
  aria-disabled={disabled}
  {onclick}
>
  {@render children?.()}
</button>
```

**Anti-pattern:** Do NOT use `export let` props (Svelte 4 syntax). Do NOT use `$store` subscriptions — use `$state()` runes. Do NOT hardcode hex values — always reference `--color-*` tokens.

---

### Pattern 4: TailwindCSS 4 @theme Tokens (FE)

**Mandate source:** ADR-003 — Design tokens in @theme; architecture.md §Component: SvelteKit Frontend [Context7: tailwindlabs/tailwindcss.com]

```css
/* frontend/src/app.css — canonical @theme block */
@import "tailwindcss";
@import "@fontsource/outfit/400.css";
@import "@fontsource/outfit/700.css";
@import "@fontsource/outfit/900.css";

@theme {
  /* Colour palette — values set after M1-T01 WCAG audit */
  --color-bg-void:         #0f1012;
  --color-accent-electric: #FFD02F;   /* Yellow — verify WCAG in M1-T01 */
  --color-accent-live:     #00E055;   /* Green */
  --color-accent-blue:     #2D8CFF;   /* Blue */
  --color-accent-red:      #FF4545;   /* Red */
  --color-accent-white:    #FFFFFF;

  /* Typography */
  --font-display: 'Outfit', system-ui, sans-serif;

  /* Shadows (hard neo-brutalist) */
  --shadow-hard:    4px 4px 0px 0px #FFFFFF;
  --shadow-hard-sm: 2px 2px 0px 0px #FFFFFF;

  /* Shape */
  --radius-base: 0px;
}

html, body {
  background-color: var(--color-bg-void);
  font-family: var(--font-display);
}

@media (prefers-reduced-motion: reduce) {
  *, *::before, *::after {
    animation-duration: 0.01ms !important;
    transition-duration: 0.01ms !important;
  }
}
```

**Anti-pattern:** Do NOT create a `tailwind.config.js`. Do NOT hardcode hex values in component `<style>` blocks. Do NOT use `theme()` function — reference CSS custom properties via utility classes.

---

### Pattern 5: FastAPI Lifespan + Error Response Shape (BE)

**Mandate source:** architecture.md §Component: FastAPI API Layer [Context7: fastapi/fastapi@0.128.0]

```python
# classquiz/__init__.py — canonical lifespan pattern
from contextlib import asynccontextmanager
from fastapi import FastAPI

@asynccontextmanager
async def lifespan(app: FastAPI):
    # Startup: init DB tables, Redis, MeiliSearch
    await init_db()
    await init_redis()
    yield
    # Shutdown: close connections
    await engine.dispose()

app = FastAPI(lifespan=lifespan)

# Standard error response shape for all 4xx/5xx:
from fastapi.responses import JSONResponse
def error_response(status: int, error_type: str, message: str) -> JSONResponse:
    return JSONResponse(
        status_code=status,
        content={"error": error_type, "message": message, "code": status}
    )
# Usage: raise HTTPException or return error_response(404, "NOT_FOUND", "Quiz not found")
```

**Anti-pattern:** Do NOT use `@app.on_event("startup")` or `@app.on_event("shutdown")` — both are deprecated in FastAPI 0.95+. Do NOT return unstructured error strings from endpoints.

---

## Dependency Graph (Task DAG)

> Validated: no cycles, no orphans, no backward cross-milestone dependencies.

| Task ID | Title | Milestone | Depends On | Order |
|---------|-------|-----------|------------|-------|
| M0-T01 | Snapshot Alembic state + git tag | M0 | — | [S] |
| M0-T02 | Replace ormar with SQLModel in models.py | M0 | M0-T01 | [S][R] |
| M0-T03 | Update all router query patterns | M0 | M0-T02 | [S][R] |
| M0-T04 | Migrate FastAPI lifecycle to lifespan | M0 | M0-T03 | [S][R] |
| M0-T05 | Restore disabled answer validator | M0 | M0-T02 | [S][R] |
| M0-T06 | Add Prometheus, Grafana, Ollama to docker-compose | M0 | — | [P] |
| M0-T07 | Add prometheus-fastapi-instrumentator + LLM metrics | M0 | M0-T04 | [S] |
| M1-T01 | WCAG AA contrast audit (blocking gate) | M1 | M0 complete | [S] |
| M1-T02 | Import Outfit font + write @theme tokens | M1 | M1-T01 | [S] |
| M1-T03 | Create Button.svelte | M1 | M1-T02 | [P] |
| M1-T04 | Create Card.svelte | M1 | M1-T02 | [P] |
| M1-T05 | Add prefers-reduced-motion utility | M1 | M1-T02 | [P] |
| M2-T01 | PIN entry screen | M2 | M1 complete | [S] |
| M2-T02 | Lobby + full player flow | M2 | M2-T01 | [S] |
| M2-T03 | Disconnect/reconnect handler | M2 | M2-T02 | [S] |
| M2-T04 | Host lobby screen | M2 | M1 complete | [P] |
| M2-T05 | Host question display + answer tally | M2 | M2-T04 | [S] |
| M2-T06 | Host leaderboard + winner screens | M2 | M2-T05 | [S] |
| M3-T01 | Nav.svelte component | M3 | M1 complete | [S] |
| M3-T02 | Homepage route | M3 | M3-T01 | [S] |
| M4-T01 | Add open_ended type to models + migration | M4 | M0 complete | [S][M] |
| M4-T02 | Socket server E8 event handling | M4 | M4-T01 | [S] |
| M4-T03 | Create classquiz/llm/ module | M4 | M0-T07 | [S] |
| M4-T04 | Wire LLM into socket answer handler | M4 | M4-T02, M4-T03 | [S] |
| M4-T05 | LLM health check endpoint | M4 | M4-T03 | [P] |
| M4-T06 | OpenEndedPlayer.svelte | M4 | M1 complete, M2-T02 | [S] |
| M4-T07 | ManualReviewPanel.svelte + host verdict | M4 | M4-T04, M4-T06 | [S] |
| M5-T01 | Quiz editor layout | M5 | M1 complete | [S] |
| M5-T02 | Question cards + settings + type menu | M5 | M5-T01 | [S] |
| M5-T03 | Dashboard route | M5 | M1, M3 complete | [S] |
| M5-T04 | Results summary + profile/settings | M5 | M5-T03 | [S] |
| M6-T01 | Answer feedback flash animation | M6 | M2-T02, M4-T06 | [S] |
| M6-T02 | Score counter increment animation | M6 | M2-T02 | [P] |
| M6-T03 | Leaderboard row reorder animation | M6 | M2-T06 | [P] |
| M6-T04 | CI — SPDX MPL-2.0 audit | M6 | — | [P] |
| M6-T05 | CI — axe-core accessibility scan | M6 | M2 complete | [P] |
| M6-T06 | CI — Lighthouse mobile performance | M6 | M2 complete | [P] |

---

## Implementation Checklist

### Milestone 0: Backend Preparation

**Goal:** Replace deprecated `ormar` ORM with `SQLModel`; modernise FastAPI lifecycle; add infrastructure services (Prometheus, Grafana, Ollama) to Docker Compose. All backend code in subsequent milestones uses `SQLModel` patterns.
**PRD Stories:** Architectural prerequisite
**Depends On:** None

---

- [x] **M0-T01: Snapshot current Alembic migration state**
  - **depends_on:** —
  - **Component:** Database
  - **Story:** Architectural prerequisite
  - **Files:** `migrations/versions/` (read-only), git
  - **Tech choices:** Alembic, Git — both in Tech Manifest
  - **Acceptance criteria:**
    - Git tag `pre-sqlmodel-migration` exists as a rollback point before any ORM code changes
  - **Tests required:**
    - [ ] `alembic current` shows `head` (run in terminal, exits 0)
  - **Error handling:**
    - **What can fail:** Pending migrations exist (alembic not at head); git tag already exists
    - **Expected behavior:** If not at head → run `alembic upgrade head` first; if tag exists → verify it points to correct commit
    - **Atomicity:** Non-destructive read + tag — no rollback needed
  - **Done when:**
    - [x] `git tag pre-sqlmodel-migration` exists
    - [x] `alembic history` head identified as `9d7fa2e6b24c` (`added_mod_rating`); 25 migrations in chain
  - **Prior art:** Similar to `terraform state` snapshot before destructive infrastructure changes
  - **Status:** `[COMPLETE]`
  - **Notes:** ⚠️ Minor deviation: Python 3.13 not installed in WSL dev environment (Python 3.12.3 available). `alembic current` requires live DB — not run. Head identified via migration file chain analysis. `git tag pre-sqlmodel-migration` applied to initial brownfield baseline commit `d4c0e61`.

---

- [x] **M0-T02: Replace ormar models with SQLModel in models.py**
  - **depends_on:** M0-T01
  - **Component:** API Layer — Database
  - **Story:** Architectural prerequisite
  - **Files:** `classquiz/db/models.py`, `classquiz/db/session.py` (new), `Pipfile`
  - **Tech choices:** SQLModel `^0.0.24`, Pydantic v2, Alembic — all in Tech Manifest
  - **Acceptance criteria:**
    - All `ormar.Model` subclasses replaced with `SQLModel` + `table=True`; Pydantic-only game state models remain `BaseModel`
  - **Tests required:**
    - [ ] `tests/test_models.py`: each SQLModel table class instantiates without error
    - [ ] `alembic check` exits 0 (no unresolved schema drift)
  - **Error handling:**
    - **What can fail:** Schema drift detected by Alembic after rewrite; UUID PK type mismatch; missing `Optional` on nullable fields
    - **Expected behavior:** Alembic check → generate corrective migration if drift; tests fail immediately on model error
    - **Atomicity:** If alembic check fails, generate migration before proceeding to M0-T03
  - **Done when:**
    - [x] No `ormar` imports in `classquiz/db/models.py` (only comments remain)
    - [ ] `alembic check` exits 0 (requires live DB — deferred to post-M0-T04)
    - [ ] Model instantiation tests pass (deferred to M0-T06 when pipenv env installed)
  - **Prior art:** SQLModel UUIDs use `Optional[uuid.UUID] = Field(default_factory=uuid.uuid4, primary_key=True)` — different from ormar's `ormar.UUID(primary_key=True)`
  - **Status:** `[COMPLETE]`
  - **Notes:** Duplicate ormar classes appended by prior session's large replacement; removed by truncating file at line 703. `classquiz/db/__init__.py` stripped of `sqlalchemy.MetaData()` (kept `database` for backward compat). `migrations/env.py` updated to `SQLModel.metadata`. Syntax verified via `py_compile`. Full import test deferred — `sentry_sdk` not installed in system Python; `alembic check` deferred — requires live DB.

---

- [ ] **M0-T03: Update all router query patterns to SQLModel async sessions**
  - **depends_on:** M0-T02
  - **Component:** API Layer
  - **Story:** Architectural prerequisite
  - **Files:** `classquiz/routers/*.py`, `classquiz/routers/users/*.py`, `classquiz/socket_server/__init__.py`, `classquiz/worker/*.py`
  - **Tech choices:** SQLModel, FastAPI `Depends`, asyncpg — all in Tech Manifest
  - **Acceptance criteria:**
    - All ormar query patterns replaced; full test suite passes; no `ormar` imports anywhere in `classquiz/`
  - **Tests required:**
    - [ ] All `classquiz/tests/test_auth.py` tests pass
    - [ ] All `classquiz/tests/test_server.py` tests pass
  - **Error handling:**
    - **What can fail:** Missing `session` dependency on router functions; `select()` result type mismatch (SQLModel returns sequence, not single model); async session not properly closed
    - **Expected behavior:** Test failures → fix each router file before moving to next; session must use `async with` or `Depends(get_session)`
    - **Atomicity:** Migrate one router file at a time; run test suite after each file
  - **Done when:**
    - [ ] `grep -r "import ormar" classquiz/` returns empty
    - [ ] `coverage run -m pytest classquiz/tests/` exits 0
  - **Prior art:** Follows SQLAlchemy 2.0 async session pattern; see FastAPI SQL databases tutorial
  - **Status:** `[PENDING]`
  - **Notes:**

---

- [ ] **M0-T04: Migrate FastAPI lifecycle to lifespan context manager**
  - **depends_on:** M0-T03
  - **Component:** API Layer
  - **Story:** Architectural prerequisite
  - **Files:** `classquiz/__init__.py`
  - **Tech choices:** FastAPI `^*` (0.128.0 verified), `asynccontextmanager` — in Tech Manifest
  - **Acceptance criteria:**
    - `@app.on_event` deprecated decorators replaced with `@asynccontextmanager lifespan`; app starts without deprecation warnings
  - **Tests required:**
    - [ ] App starts and responds to `GET /api/v1/utils/ping` → 200 (smoke test)
  - **Error handling:**
    - **What can fail:** Startup logic error inside lifespan (DB unreachable, Redis unreachable) → app fails to start
    - **Expected behavior:** Startup errors are raised during lifespan context entry → Docker Compose reports unhealthy; not silently swallowed
    - **Atomicity:** Move all `on_startup` code into lifespan `yield` preamble; `on_shutdown` code goes after `yield`
  - **Done when:**
    - [ ] No `@app.on_event` decorators in `classquiz/__init__.py`
    - [ ] `FastAPI(lifespan=lifespan)` present
    - [ ] App smoke test passes
  - **Prior art:** FastAPI lifespan docs [Context7: fastapi/fastapi@0.128.0]
  - **Status:** `[PENDING]`
  - **Notes:**

---

- [ ] **M0-T05: Restore disabled live game answer validator**
  - **depends_on:** M0-T02
  - **Component:** API Layer
  - **Story:** Architectural prerequisite (bug fix)
  - **Files:** `classquiz/routers/live.py`
  - **Tech choices:** Pydantic v2 `@field_validator` — in Tech Manifest
  - **Acceptance criteria:**
    - `answers_not_none_if_abcd_type` validator body restored; ABCD questions reject `None` answers; `open_ended` questions accept `None` answers
  - **Tests required:**
    - [ ] pytest: ABCD question with `None` answers raises `ValidationError`
    - [ ] pytest: `open_ended` question with `None` answers is valid
  - **Error handling:**
    - **What can fail:** Pydantic v2 `@field_validator` syntax differs from v1 — must use `mode='before'` / `mode='after'` correctly
    - **Expected behavior:** `ValidationError` raised with descriptive message on invalid input; game loop not disrupted by validator errors
    - **Atomicity:** Restore validator in isolation; run live.py tests before proceeding
  - **Done when:**
    - [ ] Validator is active (not returning `v` unconditionally)
    - [ ] Both validator tests pass
    - [ ] No regression on existing game loop tests
  - **Prior art:** Pydantic v2 field validator: `@field_validator('answers', mode='before')`
  - **Status:** `[PENDING]`
  - **Notes:**

---

- [ ] **M0-T06: Add Prometheus, Grafana, and Ollama to docker-compose.yml**
  - **depends_on:** —
  - **Component:** Infrastructure
  - **Story:** ADR-006, ADR-002
  - **Files:** `docker-compose.yml`, `docker-compose.dev.yml`, `prometheus/prometheus.yml` (new), `grafana/dashboards/partyquiz.json` (new)
  - **Tech choices:** Docker Compose, Prometheus, Grafana, Ollama — all in Tech Manifest
  - **Acceptance criteria:**
    - `docker compose up` starts all three new services; Grafana accessible at `:3000`; Prometheus targets show `api` as UP
  - **Tests required:**
    - [ ] `docker compose up` exits without error for prometheus, grafana, ollama services
    - [ ] `curl http://localhost:9090/targets` shows api target
  - **Error handling:**
    - **What can fail:** Port conflicts (9090/3000/11434); volume permissions; Prometheus scrape target unreachable before api starts
    - **Expected behavior:** Port conflicts → document in README; Prometheus tolerates api being temporarily down (scrape, don't fail)
    - **Atomicity:** Services are additive — existing services unaffected
  - **Done when:**
    - [ ] All three services start
    - [ ] Grafana dashboard accessible at `:3000`
    - [ ] `prometheus/prometheus.yml` scrapes `api:8000/metrics` every 15s
    - [ ] `README.md` updated with `ollama pull llama3.1` setup step
  - **Prior art:** Standard Prometheus + Grafana Docker Compose setup; [Context7: litellm_ai] Ollama configuration
  - **Status:** `[PENDING]`
  - **Notes:**

---

- [ ] **M0-T07: Add prometheus-fastapi-instrumentator + LLM metrics stubs**
  - **depends_on:** M0-T04
  - **Component:** API Layer — Observability
  - **Story:** ADR-006
  - **Files:** `classquiz/__init__.py`, `classquiz/llm/__init__.py`, `Pipfile`
  - **Tech choices:** prometheus-fastapi-instrumentator, LiteLLM — both in Tech Manifest
  - **Acceptance criteria:**
    - `GET /metrics` returns valid Prometheus text format; LLM histogram appears after one `evaluate_answer()` call
  - **Tests required:**
    - [ ] `GET /api/v1/utils/ping` still returns 200 after metrics mount
    - [ ] `GET /metrics` returns HTTP 200 with `text/plain; version=0.0.4` content-type
  - **Error handling:**
    - **What can fail:** `/metrics` route conflicts with existing routes; Prometheus client not thread-safe with multiple workers (but `MAX_WORKERS=1` mitigates)
    - **Expected behavior:** If metrics endpoint fails → do not block app startup; log warning
    - **Atomicity:** Add instrumentator mount; if it fails, app still starts
  - **Done when:**
    - [ ] `GET /metrics` returns Prometheus text format
    - [ ] `llm_eval_duration_seconds`, `llm_eval_calls_total`, `llm_eval_errors_total` counter names stubbed in `classquiz/llm/__init__.py` (even if LLM module not yet functional)
  - **Prior art:** `prometheus-fastapi-instrumentator` package; standard FastAPI Prometheus integration
  - **Status:** `[PENDING]`
  - **Notes:**

#### Milestone 0 Verification
- [ ] All M0 tasks marked [COMPLETE]
- [ ] `grep -r "import ormar" classquiz/` → empty
- [ ] `coverage run -m pytest classquiz/tests/` exits 0 (no regressions)
- [ ] `docker compose up` starts prometheus, grafana, ollama
- [ ] `/metrics` accessible and scraping

**Milestone completed on:** PENDING

---

### Milestone 1: Design System Foundation

**Goal:** High-Voltage Arcade design token layer, Outfit font, WCAG-verified palette, and base components (Button, Card) exist and usable by all epics.
**PRD Stories:** E1-S1, E1-S2, E1-S3, E1-S4, E1-S5, E4-S1, E6-S4
**Depends On:** M0

---

- [ ] **M1-T01: WCAG AA contrast audit (blocking gate)**
  - **depends_on:** M0 complete
  - **Component:** SvelteKit Frontend — Design System
  - **Story:** E1-S1 — WCAG audit
  - **Files:** `specs/decisions/wcag-audit.md` (new)
  - **Tech choices:** axe-core CLI or Colour Contrast Analyser (external tool)
  - **Acceptance criteria:**
    - Given the design palette, when contrast ratios are measured, then all text/background combinations pass WCAG 2.1 AA (4.5:1 normal text, 3:1 large text); adjusted hex values are documented and locked
  - **Tests required:**
    - [ ] Document `specs/decisions/wcag-audit.md` with ratios for all 5 colours + white on `#0f1012`
  - **Error handling:**
    - **What can fail:** One or more accent colours fail contrast ratio — nearest passing hex must be found and substituted
    - **Expected behavior:** If colour fails → find nearest passing value; document original vs adjusted; all subsequent tasks use adjusted values
    - **Atomicity:** Gate — no M1-T02 until this document exists with all values locked
  - **Done when:**
    - [ ] `specs/decisions/wcag-audit.md` exists with pass/fail + ratio for each colour
    - [ ] Final hex values locked for #FFD02F, #00E055, #2D8CFF, #FF4545, #FFFFFF on #0f1012
  - **Prior art:** WCAG contrast checker tool (WebAIM), axe-core colour rules
  - **Status:** `[PENDING]`
  - **Notes:**

---

- [ ] **M1-T02: Import Outfit font + write @theme tokens**
  - **depends_on:** M1-T01
  - **Component:** SvelteKit Frontend — Design System
  - **Story:** E1-S2 (tokens), E1-S3 (Outfit), E4-S1 (global dark base)
  - **Files:** `frontend/src/app.css`, `frontend/package.json`
  - **Tech choices:** TailwindCSS 4 `@theme`, `@fontsource/outfit` `^5` — both in Tech Manifest [Context7: tailwindlabs/tailwindcss.com]
  - **Acceptance criteria:**
    - Given a browser loading the app, when fonts render, then Outfit displays in all weighted variants with no request to fonts.googleapis.com; all `--color-*`, `--font-*`, `--shadow-*`, `--radius-*` tokens in `@theme {}` generate `:root` CSS custom properties
  - **Tests required:**
    - [ ] Vitest: `app.css` contains `@theme` block with required token names (CSS content test)
    - [ ] Manual: DevTools Network tab shows no `fonts.googleapis.com` request
  - **Error handling:**
    - **What can fail:** `@fontsource/outfit` package not found; token name typos cause missing utility classes; `@theme` block not parsed if postcss config is missing
    - **Expected behavior:** Missing package → `pnpm install` fails explicitly; typo → missing utility class (test catches it); postcss config → verify `postcss.config.cjs` includes `@tailwindcss/postcss` plugin
    - **Atomicity:** App.css changes are additive; if tokens wrong, revert to last working state
  - **Done when:**
    - [ ] Outfit renders in browser at 400/700/900 weights
    - [ ] All token names present: `--color-bg-void`, `--color-accent-electric`, `--color-accent-live`, `--color-accent-blue`, `--color-accent-red`, `--color-accent-white`, `--font-display`, `--shadow-hard`, `--shadow-hard-sm`, `--radius-base`
    - [ ] No Google Fonts request
    - [ ] Vitest token test passes
  - **Prior art:** Canonical pattern in Pattern 4 above; [Context7: tailwindlabs/tailwindcss.com]
  - **Status:** `[PENDING]`
  - **Notes:**

---

- [ ] **M1-T03: Create Button.svelte base component**
  - **depends_on:** M1-T02
  - **Component:** SvelteKit Frontend — Design System
  - **Story:** E1-S4 — Button component
  - **Files:** `frontend/src/lib/components/ui/Button.svelte`, `frontend/src/lib/components/ui/Button.test.ts`
  - **Tech choices:** SvelteKit, Svelte 5 Runes `$props()`, TailwindCSS 4 tokens — all in Tech Manifest [Context7: svelte_dev_kit]
  - **Acceptance criteria:**
    - Given a Button component, when rendered with any variant, then it: uses token-driven colours (no hardcoded hex), has `aria-disabled` when disabled, renders all 4 variants without error
  - **Tests required:**
    - [ ] Vitest: all 4 variants render without error
    - [ ] Vitest: `disabled` prop adds `aria-disabled="true"` attribute
  - **Error handling:**
    - **What can fail:** Missing `$props()` rune (Svelte 4 syntax used by mistake); token class name typo generates no styles
    - **Expected behavior:** Wrong API → TypeScript error; typo → class visually missing (Vitest snapshot catches it)
    - **Atomicity:** Standalone component; revert file on failure
  - **Done when:**
    - [ ] All 4 variants render
    - [ ] No hardcoded hex values in component
    - [ ] SPDX `MPL-2.0` header present
    - [ ] Both Vitest tests pass
  - **Prior art:** See Canonical Pattern 3 above
  - **Status:** `[PENDING]`
  - **Notes:**

---

- [ ] **M1-T04: Create Card.svelte base component**
  - **depends_on:** M1-T02
  - **Component:** SvelteKit Frontend — Design System
  - **Story:** E1-S5 — Card component
  - **Files:** `frontend/src/lib/components/ui/Card.svelte`
  - **Tech choices:** Svelte 5 Runes, TailwindCSS 4 tokens — in Tech Manifest
  - **Acceptance criteria:**
    - Given a Card, when rendered, then it has dark surface (`bg-bg-void`), hard white border (`border-2 border-white`), hard shadow (`shadow-hard`), zero border-radius
  - **Tests required:**
    - [ ] Vitest: Card renders without error; snapshot includes expected class names
  - **Error handling:**
    - **What can fail:** Token class names not generated by TailwindCSS → card shows wrong styles; must use correct token namespace
    - **Expected behavior:** Missing class → snapshot diff catches it; fix token naming
    - **Atomicity:** Standalone component
  - **Done when:**
    - [ ] Vitest render test passes
    - [ ] SPDX header present
    - [ ] No hardcoded hex values
  - **Prior art:** Canonical Pattern 3
  - **Status:** `[PENDING]`
  - **Notes:**

---

- [ ] **M1-T05: Add prefers-reduced-motion utility**
  - **depends_on:** M1-T02
  - **Component:** SvelteKit Frontend — Design System
  - **Story:** E6-S4 — Motion accessibility
  - **Files:** `frontend/src/app.css`
  - **Tech choices:** TailwindCSS 4, CSS `@media` — in Tech Manifest
  - **Acceptance criteria:**
    - Given a user with `prefers-reduced-motion: reduce`, when any animated component renders, then all animations and transitions complete in ≤ 0.01ms (effectively suppressed)
  - **Tests required:**
    - [ ] Playwright: with `prefers-reduced-motion: reduce` media setting active, verify no CSS transition fires on Button hover
  - **Error handling:**
    - **What can fail:** `!important` override not applied to all elements; media query syntax error
    - **Expected behavior:** If suppression fails → Playwright test catches it
    - **Atomicity:** CSS append only; no breaking changes
  - **Done when:**
    - [ ] `@media (prefers-reduced-motion: reduce)` block appended to `app.css`
    - [ ] Playwright test confirms no transitions with motion preference
  - **Prior art:** Standard WCAG 2.1 AA motion safety pattern
  - **Status:** `[PENDING]`
  - **Notes:**

#### Milestone 1 Verification
- [ ] All M1 tasks marked [COMPLETE]
- [ ] Vitest: Button + Card tests pass
- [ ] No `fonts.googleapis.com` request
- [ ] WCAG audit doc locked with verified hex values
- [ ] `@theme` block has all required token names

**Milestone completed on:** PENDING

---

### Milestone 2: Core Game Loop Reskinned

**Goal:** Complete live game session — PIN entry through final results — works end-to-end with new design on mobile (375px) and desktop/TV (1280px).
**PRD Stories:** E2-S1→E2-S6, E3-S1→E3-S5
**Depends On:** M1

> **Regression guard:** Run `coverage run -m pytest classquiz/tests/test_server.py` between tasks.

---

- [ ] **M2-T01: PIN entry screen**
  - **depends_on:** M1 complete
  - **Component:** SvelteKit Frontend — Player UI
  - **Story:** E2-S1 (PIN entry), E2-S6 (error state)
  - **Files:** `frontend/src/routes/play/+page.svelte`
  - **Tech choices:** Svelte 5 Runes, TailwindCSS 4 tokens, `Button` component — in Tech Manifest
  - **Acceptance criteria:**
    - Given a player on a 375px mobile viewport, when they enter a game PIN, then: tap targets are ≥ 44px; invalid PIN shows inline error without redirect; valid PIN navigates to lobby; Outfit font and `--color-bg-void` background are applied
  - **Tests required:**
    - [ ] Playwright: valid game PIN → lobby screen loaded
    - [ ] Playwright: invalid PIN → inline error, no redirect
  - **Error handling:**
    - **What can fail:** Game PIN API call fails (network); game not found (404); player already in game
    - **Expected behavior:** Network error → show "Connection failed, try again" inline; 404 → "Game not found" inline message
    - **Atomicity:** UI-only changes; no backend changes
  - **Done when:**
    - [ ] Renders correctly at 375px with tap targets ≥ 44px
    - [ ] Both Playwright tests pass
    - [ ] No hardcoded colours
  - **Prior art:** Standard form error pattern; see existing `+page.svelte` for current socket logic to preserve
  - **Status:** `[PENDING]`
  - **Notes:**

---

- [ ] **M2-T02: Lobby wait screen + full player flow**
  - **depends_on:** M2-T01
  - **Component:** SvelteKit Frontend — Player UI
  - **Story:** E2-S2 (lobby), E2-S3 (question), E2-S4 (leaderboard), E2-S5 (results)
  - **Files:** `frontend/src/routes/play/game/` (lobby, question, leaderboard, results)
  - **Tech choices:** Svelte 5 Runes, TailwindCSS 4 tokens, Socket.IO client — in Tech Manifest
  - **Acceptance criteria:**
    - Given a player at 375px, when a full game runs, then: all 4 transitions (lobby→question→leaderboard→results) succeed; answer buttons ≥ 44px; selected answer shows highlight; timer countdown visible; rank + score + correct-count above fold on results screen; lobby shows CSS "waiting" animation
  - **Tests required:**
    - [ ] Playwright: complete game loop as player at 375px — all 4 transitions succeed
    - [ ] Playwright: answer button tap locks further input, shows waiting state
  - **Error handling:**
    - **What can fail:** Socket disconnect mid-game; question event arrives before lobby renders; answer submission race condition
    - **Expected behavior:** Mid-game disconnect → M2-T03 reconnect handler; question before lobby → queue event until component ready
    - **Atomicity:** Migrate and redesign each screen in sequence; run game loop test after each screen
  - **Done when:**
    - [ ] All 4 screens render at 375px
    - [ ] Both Playwright tests pass
    - [ ] Backend regression tests pass
  - **Prior art:** Existing `play/game/` routes — preserve socket event handling, restyle with tokens
  - **Status:** `[PENDING]`
  - **Notes:**

---

- [ ] **M2-T03: Disconnect/reconnect handler**
  - **depends_on:** M2-T02
  - **Component:** SvelteKit Frontend — Player UI
  - **Story:** E2-S6 — Disconnect/reconnect
  - **Files:** `frontend/src/lib/socket.ts`, active game route components
  - **Tech choices:** Socket.IO client, Svelte 5 Runes — in Tech Manifest
  - **Acceptance criteria:**
    - Given a socket disconnect during a game, when reconnect is attempted, then: overlay shows within 1s; 5-attempt exponential backoff runs; on success: game state restored; on failure: "Connection lost" + "Try again" button shown
  - **Tests required:**
    - [ ] Playwright: mock disconnect → indicator shown → reconnect success → state restored
    - [ ] Playwright: 5 failed reconnects → final error state shown
  - **Error handling:**
    - **What can fail:** Socket.IO `reconnectionAttempts` config ignored; game state stale on reconnect
    - **Expected behavior:** Each failed attempt → increment counter shown to player; exhausted → degrade gracefully to error state
    - **Atomicity:** Modifies `socket.ts` singleton — test isolated from game flow tests
  - **Done when:**
    - [ ] Both Playwright reconnect tests pass
    - [ ] Overlay appears within 1s of disconnect
  - **Prior art:** Socket.IO client reconnection options API; standard network resilience UX pattern
  - **Status:** `[PENDING]`
  - **Notes:**

---

- [ ] **M2-T04: Host lobby screen**
  - **depends_on:** M1 complete
  - **Component:** SvelteKit Frontend — Host UI
  - **Story:** E3-S1 — Host lobby
  - **Files:** `frontend/src/routes/host/` (lobby screen)
  - **Tech choices:** Svelte 5 Runes, tokens, Socket.IO — in Tech Manifest
  - **Acceptance criteria:**
    - Given a host on a 1280px desktop viewport, when the lobby loads, then: game PIN is displayed at ≥ 96px font size; joining players appear in real-time list within 1s of socket event
  - **Tests required:**
    - [ ] Playwright: player join socket event → name appears in list within 1s
  - **Error handling:**
    - **What can fail:** Socket event not received; PIN element font-size not ≥ 96px
    - **Expected behavior:** Socket event failure → preserve existing error handling; font-size → Playwright computed style check
    - **Atomicity:** Standalone host screen; no backend changes
  - **Done when:**
    - [ ] PIN ≥ 96px font size
    - [ ] Playwright player join test passes
  - **Prior art:** See existing host lobby route; preserve socket event handling
  - **Status:** `[PENDING]`
  - **Notes:**

---

- [ ] **M2-T05: Host question display + answer tally**
  - **depends_on:** M2-T04
  - **Component:** SvelteKit Frontend — Host UI
  - **Story:** E3-S2 (question display), E3-S3 (tally)
  - **Files:** `frontend/src/routes/host/` (question + tally screens)
  - **Tech choices:** Svelte 5 Runes, tokens — in Tech Manifest
  - **Acceptance criteria:**
    - Given a host viewing a question, when answers are received, then: animated countdown timer shows; answer tally updates live; correct answer is highlighted after reveal; per-option stat bars shown
  - **Tests required:**
    - [ ] Playwright: tally counter increments on answer submit socket event
  - **Error handling:**
    - **What can fail:** Animation not respected by prefers-reduced-motion override
    - **Expected behavior:** `app.css` override suppresses automatically (M1-T05)
    - **Atomicity:** Sequential host screens; run regression after each
  - **Done when:**
    - [ ] Both screens render at 1280px
    - [ ] Timer animates; tally updates live
    - [ ] Backend regression tests pass
  - **Prior art:** Existing host question route; preserve socket state
  - **Status:** `[PENDING]`
  - **Notes:**

---

- [ ] **M2-T06: Host leaderboard + winner screens**
  - **depends_on:** M2-T05
  - **Component:** SvelteKit Frontend — Host UI
  - **Story:** E3-S4 (leaderboard), E3-S5 (winner)
  - **Files:** `frontend/src/routes/host/` (leaderboard + winner)
  - **Tech choices:** Svelte 5 Runes, tokens — in Tech Manifest
  - **Acceptance criteria:**
    - Given a host on the leaderboard screen, when players are ranked, then: top-N ranking shows with ≥ 32px font; rank movement indicators present; winner screen is visually distinct from intermediate leaderboard; co-winner support works
  - **Tests required:**
    - [ ] Playwright: leaderboard renders top-5; rank movement indicator present
  - **Error handling:**
    - **What can fail:** Co-winner tie-breaking logic not reflected in UI; rank movement indicator missing
    - **Expected behavior:** UI renders whatever data backend provides; indicator shows delta from previous round
    - **Atomicity:** Standalone screens
  - **Done when:**
    - [ ] Both screens render at 1280px
    - [ ] Leaderboard Playwright test passes
  - **Prior art:** Existing host leaderboard route
  - **Status:** `[PENDING]`
  - **Notes:**

#### Milestone 2 Verification
- [ ] All M2 tasks marked [COMPLETE]
- [ ] Playwright game loop test passes end-to-end (player 375px + host 1280px)
- [ ] Disconnect/reconnect test passes
- [ ] Backend regression: `test_server.py` + `test_auth.py` pass

**Milestone completed on:** PENDING

---

### Milestone 3: Shell & Homepage

**Goal:** Public-facing homepage and global navigation carry the new brand identity.
**PRD Stories:** E4-S2, E4-S3
**Depends On:** M1

---

- [ ] **M3-T01: Nav.svelte component**
  - **depends_on:** M1 complete
  - **Component:** SvelteKit Frontend — Layout
  - **Story:** E4-S2 — Navigation
  - **Files:** `frontend/src/lib/components/layout/Nav.svelte`
  - **Tech choices:** Svelte 5 Runes, `Button` component, TailwindCSS 4 tokens — in Tech Manifest
  - **Acceptance criteria:**
    - Given a user on any page, when the nav renders, then: logo + navigation links + auth CTA are visible; mobile collapse works at 375px; auth CTA switches between signed-in and signed-out states; uses `Button` component
  - **Tests required:**
    - [ ] Playwright: renders at 375px (collapsed) and 1280px (expanded)
    - [ ] Playwright: signed-in vs signed-out CTA states render correctly
  - **Error handling:**
    - **What can fail:** Mobile collapse JS not triggering; auth state not propagated from `hooks.server.ts`
    - **Expected behavior:** Collapse → CSS-only approach preferred; auth state via SvelteKit `page.data.user`
    - **Atomicity:** Standalone component in `src/lib/` — not yet placed in layout
  - **Done when:**
    - [ ] Renders at 375px and 1280px
    - [ ] SPDX header present
    - [ ] Both Playwright tests pass
  - **Prior art:** Existing nav markup in current layout
  - **Status:** `[PENDING]`
  - **Notes:**

---

- [ ] **M3-T02: Homepage route**
  - **depends_on:** M3-T01
  - **Component:** SvelteKit Frontend — Routes
  - **Story:** E4-S3 (homepage), E4-S1 (global dark base)
  - **Files:** `frontend/src/routes/+page.svelte`, `frontend/src/routes/+layout.svelte`
  - **Tech choices:** Svelte 5 Runes, TailwindCSS 4 tokens, Nav component — in Tech Manifest
  - **Acceptance criteria:**
    - Given an unauthenticated user on `/`, when the page loads, then: hero section + "Host a Quiz" CTA visible; bento grid layout shows feature cards; `--color-bg-void` applied globally via layout; authenticated user sees redirect or recent quizzes grid
  - **Tests required:**
    - [ ] Playwright: unauthenticated → hero + CTA visible
    - [ ] Playwright: authenticated → dashboard redirect or recent quizzes shown
  - **Error handling:**
    - **What can fail:** `+layout.svelte` bg token not applied to all child routes; authenticated state check fails server-side
    - **Expected behavior:** Token not applied → check that `--color-bg-void` is on `html, body` in `app.css` (M1-T02); auth check error → 500 logged to Sentry
    - **Atomicity:** Layout change affects all routes — verify no other routes break
  - **Done when:**
    - [ ] Homepage passes visual verification at 375px + 1280px
    - [ ] Both Playwright tests pass
  - **Prior art:** Existing homepage route; bento grid is new layout
  - **Status:** `[PENDING]`
  - **Notes:**

#### Milestone 3 Verification
- [ ] Nav renders at both breakpoints
- [ ] Homepage passes unauthenticated + authenticated tests

**Milestone completed on:** PENDING

---

### Milestone 4: LLM Open-Ended Questions

**Goal:** Open-ended questions work end-to-end — editor through live game judgment — with fallback if LLM unavailable.
**PRD Stories:** E8-S1→E8-S5
**Depends On:** M2 (game loop must be stable before adding new question type)

---

- [ ] **M4-T01: Add open_ended question type to models + Alembic migration**
  - **depends_on:** M0 complete
  - **Component:** API Layer — Database
  - **Story:** E8-S1 — Open-ended backend
  - **Files:** `classquiz/db/models.py`, `migrations/versions/NNN_add_open_ended_question_type.py`
  - **Tech choices:** SQLModel, Pydantic v2, Alembic — in Tech Manifest
  - **Acceptance criteria:**
    - Given a Quiz with an `open_ended` question type, when saved to the database, then: the question saves and retrieves correctly; `llm_rubric` field round-trips through JSON serialisation; migration applies cleanly
  - **Tests required:**
    - [ ] pytest: `Quiz` with `open_ended` type saves and retrieves correctly
    - [ ] pytest: `open_ended` question with `llm_rubric` round-trips through JSON serialisation
  - **Error handling:**
    - **What can fail:** Alembic migration generates a real schema change (wrong) — should be comment-record only; `llm_rubric` not Optional causes validation errors on existing questions
    - **Expected behavior:** Confirm `questions` column is JSON type → adding Pydantic field is schema-free; `llm_rubric: str | None = None` ensures backward compat
    - **Atomicity:** Migration is a comment-record; if anything fails, `alembic downgrade -1` rolls back
  - **Done when:**
    - [ ] Both pytest tests pass
    - [ ] Migration applies: `alembic upgrade head` exits 0
    - [ ] `open_ended` and `llm_rubric` in `QuizQuestion` Pydantic model
  - **Prior art:** Existing JSON column pattern in `classquiz/db/models.py`
  - **Status:** `[PENDING]`
  - **Notes:**

---

- [ ] **M4-T02: Socket server E8 event handling**
  - **depends_on:** M4-T01
  - **Component:** Game Engine
  - **Story:** E8-S1 — Open-ended backend
  - **Files:** `classquiz/socket_server/__init__.py`, `classquiz/socket_server/models.py`
  - **Tech choices:** python-socketio, Redis — in Tech Manifest
  - **Acceptance criteria:**
    - Given an open_ended question during a live game, when a player submits an answer, then: answer text stored in Redis; dispatched for LLM evaluation asynchronously; score not emitted until verdict arrives; `open_ended` question event broadcast with no `answers` array
  - **Tests required:**
    - [ ] pytest: mock LLM → open_ended question event contains no answers array
    - [ ] pytest: answer stored in Redis game state without immediate score emission
  - **Error handling:**
    - **What can fail:** Answer dispatch blocks event loop; Redis key collision; player submits multiple times
    - **Expected behavior:** Dispatch via `asyncio.ensure_future()` or `asyncio.create_task()` — non-blocking; de-duplicate by player_id + question_id in Redis
    - **Atomicity:** Handler is idempotent per player per question
  - **Done when:**
    - [ ] Both tests pass
    - [ ] Game loop does not block on open_ended answer
  - **Prior art:** Existing `submit_answer` handler in `classquiz/socket_server/__init__.py`
  - **Status:** `[PENDING]`
  - **Notes:**

---

- [ ] **M4-T03: Create classquiz/llm/ evaluation module**
  - **depends_on:** M0-T07
  - **Component:** LLM Evaluation Module
  - **Story:** E8-S2 — LLM evaluation
  - **Files:** `classquiz/llm/__init__.py`, `classquiz/llm/models.py`, `classquiz/llm/health.py`
  - **Tech choices:** LiteLLM `^1.81`, asyncio, Pydantic v2 — in Tech Manifest [Context7: litellm@1.81.13]
  - **Acceptance criteria:**
    - Given valid question/answer inputs, when `evaluate_answer()` is called, then a `Verdict` is returned within `LLM_TIMEOUT_SECONDS`; on timeout or provider error, `LLMUnavailableError` is raised (never propagates to game loop)
  - **Tests required:**
    - [ ] pytest: mock `acompletion` returns correct Verdict
    - [ ] pytest: `asyncio.TimeoutError` → `LLMUnavailableError` raised
    - [ ] pytest: malformed LLM response (non-JSON) → `LLMUnavailableError` raised
  - **Error handling:**
    - **What can fail:** LLM provider unreachable; response not valid JSON; response JSON lacks `verdict` key; timeout
    - **Expected behavior per error:** All → raise `LLMUnavailableError(str(exc))` — caller handles manual review; never re-raise raw exceptions to socket server
    - **Atomicity:** Standalone Library-First module (Article I); no side effects on import
  - **Done when:**
    - [ ] All 3 pytest tests pass
    - [ ] Module has no imports of `classquiz.routers` or any framework layer
    - [ ] SPDX MPL-2.0 header in all 3 files
  - **Prior art:** Canonical Pattern 2 above [Context7: litellm@1.81.13]
  - **Status:** `[PENDING]`
  - **Notes:**

---

- [ ] **M4-T04: Wire LLM module into socket server answer handler**
  - **depends_on:** M4-T02, M4-T03
  - **Component:** Game Engine — LLM Module
  - **Story:** E8-S2 (evaluation), E8-S5 (manual fallback)
  - **Files:** `classquiz/socket_server/__init__.py`
  - **Tech choices:** python-socketio, LiteLLM module — in Tech Manifest
  - **Acceptance criteria:**
    - Given an open_ended answer submission, when LLM evaluation succeeds, then `llm_verdict` event is emitted to player SID + host count updated; when `LLMUnavailableError` raised, then `manual_review_required` event emitted to host SID only; game loop never hangs
  - **Tests required:**
    - [ ] Integration test: mock LLM success → `llm_verdict` emitted to correct player SID
    - [ ] Integration test: mock `LLMUnavailableError` → `manual_review_required` emitted to host only; player receives waiting state
  - **Error handling:**
    - **What can fail:** `evaluate_answer` call blocks event loop (must be async); LLM error propagates up (must be caught); wrong SID targeted
    - **Expected behavior:** `await evaluate_answer(...)` inside `try/except LLMUnavailableError`; `asyncio.create_task()` if fire-and-forget needed; SID from session must be validated before emit
    - **Atomicity:** Circuit-breaker (try/except) is the non-negotiable guarantee; game never stalls
  - **Done when:**
    - [ ] Both integration tests pass
    - [ ] Game loop verified non-blocking under mock LLM failure
  - **Prior art:** Standard async circuit-breaker pattern; `try/except` on external async call
  - **Status:** `[PENDING]`
  - **Notes:**

---

- [ ] **M4-T05: LLM health check endpoint**
  - **depends_on:** M4-T03
  - **Component:** API Layer — LLM Module
  - **Story:** E8-S2 — LLM evaluation
  - **Files:** `classquiz/routers/utils.py`
  - **Tech choices:** FastAPI, LiteLLM health module — in Tech Manifest
  - **Acceptance criteria:**
    - Given an admin user, when they call `GET /api/v1/llm/health`, then: 200 + `{"status": "healthy", "provider": "...", "latency_ms": N}` when LLM reachable; 503 + `{"status": "unhealthy", "error": "..."}` when not; non-admin → 403
  - **Tests required:**
    - [ ] pytest: admin auth → 200 when LLM healthy
    - [ ] pytest: admin auth → 503 when LLM unavailable (mock timeout)
    - [ ] pytest: non-admin → 403
  - **Error handling:**
    - **What can fail:** Health check call takes too long (use 2s timeout, not production timeout); admin flag not checked
    - **Expected behavior:** 2s timeout hardcoded in health check; use `Depends(get_current_user)` + `is_admin` check
    - **Atomicity:** Read-only endpoint; no state changes
  - **Done when:**
    - [ ] All 3 pytest tests pass
  - **Prior art:** Standard FastAPI admin-guarded endpoint; existing admin routes in `classquiz/routers/admin.py`
  - **Status:** `[PENDING]`
  - **Notes:**

---

- [ ] **M4-T06: OpenEndedPlayer.svelte component**
  - **depends_on:** M1 complete, M2-T02
  - **Component:** SvelteKit Frontend — E8 UI
  - **Story:** E8-S3 — Player text input
  - **Files:** `frontend/src/lib/components/game/OpenEndedPlayer.svelte`
  - **Tech choices:** Svelte 5 Runes, TailwindCSS 4 tokens, `Button` component — in Tech Manifest
  - **Acceptance criteria:**
    - Given a player on a 375px mobile viewport with an open_ended question, when they type an answer, then: text input is visible above fold; on submit: input locks, waiting spinner shows; on `llm_verdict` socket event: feedback state shows correct/incorrect with token-coloured flash; motion preference respected
  - **Tests required:**
    - [ ] Playwright: text input visible above fold at 375px
    - [ ] Playwright: submit → locked → waiting → verdict → feedback state transitions all pass
  - **Error handling:**
    - **What can fail:** Keyboard pushes viewport and hides input (mobile scroll); verdict event never arrives (LLM down); double-submit
    - **Expected behavior:** Viewport meta tag handles keyboard push; if verdict never arrives → polling timeout shows "waiting for host" state; double-submit prevented by input lock on first submit
    - **Atomicity:** New component in `src/lib/components/game/`
  - **Done when:**
    - [ ] Renders above fold at 375px
    - [ ] All Playwright state transition tests pass
    - [ ] SPDX header present
  - **Prior art:** E2-S3 question answer component as base pattern
  - **Status:** `[PENDING]`
  - **Notes:**

---

- [ ] **M4-T07: ManualReviewPanel.svelte + host verdict display**
  - **depends_on:** M4-T04, M4-T06
  - **Component:** SvelteKit Frontend — E8 UI
  - **Story:** E8-S4 (host verdict), E8-S5 (manual fallback)
  - **Files:** `frontend/src/lib/components/game/ManualReviewPanel.svelte`, host question screen
  - **Tech choices:** Svelte 5 Runes, TailwindCSS 4 tokens, `Button` component, Socket.IO — in Tech Manifest
  - **Acceptance criteria:**
    - Given a `manual_review_required` event, when the ManualReviewPanel activates, then: player answer list shows; host can click Correct/Incorrect/Partial; clicking emits `manual_verdict` socket event; player score updates on verdict; host question screen shows "Evaluated: N / M" counter on `llm_verdict` events
  - **Tests required:**
    - [ ] Playwright: mock `manual_review_required` → panel appears with player answers
    - [ ] Playwright: host clicks Correct → `manual_verdict` socket event emitted → player score updates
  - **Error handling:**
    - **What can fail:** `manual_review_required` arrives while host is on different screen; duplicate `manual_verdict` for same player-question
    - **Expected behavior:** Panel overlays current host screen regardless of which screen is active; server de-duplicates verdicts by player_id+question_id
    - **Atomicity:** New component; host question screen is modified separately
  - **Done when:**
    - [ ] Both Playwright tests pass
    - [ ] SPDX headers present
  - **Prior art:** E3-S3 answer tally panel as structural model
  - **Status:** `[PENDING]`
  - **Notes:**

#### Milestone 4 Verification
- [ ] All M4 tasks marked [COMPLETE]
- [ ] Full open-ended round tested end-to-end
- [ ] LLM failure fallback verified (mock LLM down → manual review activates)
- [ ] `/api/v1/llm/health` accessible to admin users, 503 when LLM down

**Milestone completed on:** PENDING

---

### Milestone 5: Creator Workflow & Dashboard

**Goal:** Quiz editor fully reskinned; dashboard and supporting screens complete full-platform design consistency.
**PRD Stories:** E5-S1→E5-S4, E7-S1, E7-S2, E7-S3
**Depends On:** M1, M3

---

- [ ] **M5-T01: Quiz editor layout**
  - **depends_on:** M1 complete
  - **Component:** SvelteKit Frontend — Editor
  - **Story:** E5-S1 — Editor layout
  - **Files:** `frontend/src/routes/edit/`
  - **Tech choices:** Svelte 5 Runes, TailwindCSS 4 tokens — in Tech Manifest
  - **Acceptance criteria:**
    - Given a creator in the editor, when the page loads, then: left panel (question list), canvas area, top toolbar (Add Question, Save, Preview, Settings) are visible; quiz CRUD operations pass regression tests
  - **Tests required:**
    - [ ] `test_server.py` quiz CRUD tests pass after layout change
  - **Error handling:**
    - **What can fail:** Layout refactor breaks existing slot structure or server-side data loading
    - **Expected behavior:** Preserve existing `+page.server.ts` data loading; only restyle presentation layer
    - **Atomicity:** Redesign layout only; no behavioural changes
  - **Done when:**
    - [ ] Editor layout renders
    - [ ] `test_server.py` quiz tests pass
  - **Prior art:** Existing `edit/` route; bento grid pattern from homepage
  - **Status:** `[PENDING]`
  - **Notes:**

---

- [ ] **M5-T02: Question cards + settings form + type menu**
  - **depends_on:** M5-T01
  - **Component:** SvelteKit Frontend — Editor
  - **Story:** E5-S2 (MC card), E5-S3 (settings form), E5-S4 (type menu)
  - **Files:** `frontend/src/routes/edit/` (question cards, settings panel)
  - **Tech choices:** Svelte 5 Runes, TailwindCSS 4 tokens — in Tech Manifest
  - **Acceptance criteria:**
    - Given a creator adding a question, when they use the editor, then: MC card shows question text + 4 option inputs + correct-answer indicator; settings form has title (required), description, visibility toggle with inline validation; type menu shows MC + open text + true/false; open_ended functional; true/false shows "Coming soon" badge
  - **Tests required:**
    - [ ] Playwright: select open_ended type → text input field appears in card
    - [ ] Playwright: quiz save → quiz retrieves with correct question types
  - **Error handling:**
    - **What can fail:** `open_ended` type not wired to correct component; "Coming soon" badge accidentally enables functionality
    - **Expected behavior:** `open_ended` → shows text rubric input; MC → shows 4 answer inputs; "Coming soon" badges are inert (no click handler)
    - **Atomicity:** UI only; no new backend endpoints
  - **Done when:**
    - [ ] Open-ended type selectable and functional
    - [ ] Quiz saves + retrieves with new types
    - [ ] Both Playwright tests pass
  - **Prior art:** Existing question card components
  - **Status:** `[PENDING]`
  - **Notes:**

---

- [ ] **M5-T03: Dashboard route**
  - **depends_on:** M1, M3 complete
  - **Component:** SvelteKit Frontend — Dashboard
  - **Story:** E7-S1 — Dashboard
  - **Files:** `frontend/src/routes/dashboard/+page.svelte`
  - **Tech choices:** Svelte 5 Runes, TailwindCSS 4 tokens, Nav component, Card component — in Tech Manifest
  - **Acceptance criteria:**
    - Given an authenticated creator on `/dashboard`, when the page loads, then: bento grid of quiz cards with title + question count + last modified + Play/Edit buttons; empty state CTA shown for new users
  - **Tests required:**
    - [ ] Playwright: authenticated user → quiz grid renders
    - [ ] Playwright: new user (no quizzes) → empty state CTA shown
  - **Error handling:**
    - **What can fail:** Quiz list API call fails; empty state not shown when array is empty
    - **Expected behavior:** API failure → show retry UI with error message; empty array → render empty state CTA
    - **Atomicity:** Route redesign only; no backend changes
  - **Done when:**
    - [ ] Both Playwright tests pass
    - [ ] Quiz cards use `Card` component
  - **Prior art:** Existing dashboard route
  - **Status:** `[PENDING]`
  - **Notes:**

---

- [ ] **M5-T04: Results summary + profile/settings pages**
  - **depends_on:** M5-T03
  - **Component:** SvelteKit Frontend — Supporting Screens
  - **Story:** E7-S2 (results), E7-S3 (settings)
  - **Files:** `frontend/src/routes/results/+page.svelte`, `frontend/src/routes/settings/+page.svelte`
  - **Tech choices:** Svelte 5 Runes, TailwindCSS 4 tokens — in Tech Manifest
  - **Acceptance criteria:**
    - Given a results page, when viewing at 1280px, then ranked player list shows in bento grid; at 375px, shows stacked list; display name update on settings page does not require page reload — Nav reflects change immediately
  - **Tests required:**
    - [ ] Playwright: update display name → Nav shows updated name without page reload
  - **Error handling:**
    - **What can fail:** Display name update triggers full page reload (wrong approach); name change not reactive in Nav's `$state`
    - **Expected behavior:** Use Svelte store or invalidateAll to propagate name change; Nav reads from reactive source
    - **Atomicity:** Two independent routes; test each before moving on
  - **Done when:**
    - [ ] Results responsive at 375px and 1280px
    - [ ] Playwright display name update test passes
  - **Prior art:** SvelteKit `invalidateAll()` pattern for reactive data refresh
  - **Status:** `[PENDING]`
  - **Notes:**

#### Milestone 5 Verification
- [ ] All M5 tasks marked [COMPLETE]
- [ ] Editor functional with new design; quiz CRUD tests pass
- [ ] Dashboard, results, settings match design system

**Milestone completed on:** PENDING

---

### Milestone 6: Gamification & Polish

**Goal:** Answer feedback animations, score counters, leaderboard movement animations layered on core screens; CI accessibility + performance gates added.
**PRD Stories:** E6-S1, E6-S2, E6-S3 (Should Have)
**Depends On:** M2

---

- [ ] **M6-T01: Answer feedback flash animation**
  - **depends_on:** M2-T02, M4-T06
  - **Component:** SvelteKit Frontend — Animations
  - **Story:** E6-S1 — Answer flash animation
  - **Files:** `frontend/src/lib/components/game/OpenEndedPlayer.svelte`, MC answer screen
  - **Tech choices:** CSS `@keyframes`, TailwindCSS 4 — in Tech Manifest
  - **Acceptance criteria:**
    - Given a player who has submitted an answer, when the verdict arrives, then: correct/incorrect flash animation plays at ≥ 60fps; animation duration ≤ 300ms; suppressed with `prefers-reduced-motion: reduce`
  - **Tests required:**
    - [ ] Playwright: flash animation plays and completes within 350ms threshold
    - [ ] Playwright: `prefers-reduced-motion: reduce` → no animation
  - **Error handling:**
    - **What can fail:** Animation drops frames on low-end mobile; `prefers-reduced-motion` override not applied to `@keyframes` specifically
    - **Expected behavior:** Use CSS `transform` / `opacity` (GPU-accelerated) not `margin`/`width` changes for 60fps; global override in M1-T05 covers `@keyframes` automatically
    - **Atomicity:** CSS additions only; no behaviour changes
  - **Done when:**
    - [ ] Both Playwright tests pass
    - [ ] No hardcoded colours in animation keyframes — use token variables
  - **Prior art:** CSS `@keyframes` flash pattern; `animation-duration: 0.01ms` override in M1-T05
  - **Status:** `[PENDING]`
  - **Notes:**

---

- [ ] **M6-T02: Score counter increment animation**
  - **depends_on:** M2-T02
  - **Component:** SvelteKit Frontend — Animations
  - **Story:** E6-S2 — Score animation
  - **Files:** Player leaderboard + results screens
  - **Tech choices:** CSS counter or JS number tween, TailwindCSS 4 — in Tech Manifest
  - **Acceptance criteria:**
    - Given a player's score changing, when the leaderboard updates, then: score animates from old to new value within ≤ 500ms; suppressed with `prefers-reduced-motion`
  - **Tests required:**
    - [ ] Playwright: score counter animates on leaderboard update; completes within 550ms
    - [ ] Playwright: motion preference → immediate final value shown
  - **Done when:**
    - [ ] Both tests pass
  - **Prior art:** CSS `@property` counter animation or Svelte `tweened()`
  - **Status:** `[PENDING]`
  - **Notes:**

---

- [ ] **M6-T03: Leaderboard row reorder animation**
  - **depends_on:** M2-T06
  - **Component:** SvelteKit Frontend — Animations
  - **Story:** E6-S3 — Leaderboard animation
  - **Files:** Host leaderboard screen, player leaderboard screen
  - **Tech choices:** Svelte `animate:flip` directive — in Tech Manifest [Context7: svelte_dev_kit]
  - **Acceptance criteria:**
    - Given leaderboard rows reordering between rounds, when new rankings arrive, then: rows animate via FLIP ≤ 500ms; suppressed with `prefers-reduced-motion`
  - **Tests required:**
    - [ ] Playwright: rows animate visibly on reorder; completion within 550ms
    - [ ] Playwright: motion preference → instant reorder
  - **Done when:**
    - [ ] Both tests pass
  - **Prior art:** Svelte `animate:flip` directive (built-in)
  - **Status:** `[PENDING]`
  - **Notes:**

---

- [ ] **M6-T04: CI — SPDX MPL-2.0 header audit**
  - **depends_on:** —
  - **Component:** CI/CD
  - **Story:** NFR — SPDX compliance (cross-cutting)
  - **Files:** `.github/workflows/` (extend existing)
  - **Tech choices:** REUSE tool (fsfe/reuse-action), GitHub Actions — in Tech Manifest
  - **Acceptance criteria:**
    - Given a PR that modifies any `frontend/src/**` or `classquiz/**` file, when CI runs, then: missing SPDX MPL-2.0 header causes workflow failure
  - **Tests required:**
    - [ ] CI test: push a file without SPDX header → workflow fails
    - [ ] CI test: push compliant file → workflow passes
  - **Error handling:**
    - **What can fail:** REUSE tool not detecting headers in all file types; workflow configuration syntax error
    - **Expected behavior:** REUSE `lint` command returns non-zero on violation; GitHub Actions step `fail_on_error: true`
    - **Atomicity:** Additive CI step; does not affect existing workflows
  - **Done when:**
    - [ ] CI step fails on SPDX violation
    - [ ] CI step passes on compliant files
  - **Prior art:** FSFE REUSE specification; `reuse/action` GitHub Action
  - **Status:** `[PENDING]`
  - **Notes:**

---

- [ ] **M6-T05: CI — axe-core accessibility scan**
  - **depends_on:** M2 complete
  - **Component:** CI/CD
  - **Story:** NFR — WCAG AA accessibility
  - **Files:** `.github/workflows/`, Playwright test file
  - **Tech choices:** `@axe-core/playwright`, Playwright — in Tech Manifest
  - **Acceptance criteria:**
    - Given each redesigned route, when axe-core scans it in CI, then: 0 rule violations on `/`, `/play`, `/dashboard`, `/edit`, host game screen
  - **Tests required:**
    - [ ] axe scan: `/` → 0 violations
    - [ ] axe scan: `/play` → 0 violations
    - [ ] axe scan: `/dashboard` → 0 violations (authenticated)
    - [ ] axe scan: host game screen → 0 violations
  - **Done when:**
    - [ ] All routes pass with 0 axe violations
    - [ ] CI fails if violation is introduced
  - **Prior art:** `@axe-core/playwright` docs; existing Playwright test setup
  - **Status:** `[PENDING]`
  - **Notes:**

---

- [ ] **M6-T06: CI — Lighthouse mobile performance**
  - **depends_on:** M2 complete
  - **Component:** CI/CD
  - **Story:** NFR-P01 — Page transition performance
  - **Files:** `.github/workflows/`, `lighthouserc.json` (new)
  - **Tech choices:** `@lhci/cli` (Lighthouse CI), GitHub Actions — in Tech Manifest
  - **Acceptance criteria:**
    - Given mobile simulation CI runs on key routes, when Lighthouse scores are computed, then: performance ≥ 90 and accessibility ≥ 90 on `/play`, `/dashboard`, `/`
  - **Tests required:**
    - [ ] Lighthouse: `/play` performance ≥ 90, accessibility ≥ 90
    - [ ] Lighthouse: `/dashboard` performance ≥ 90, accessibility ≥ 90
    - [ ] Lighthouse: `/` performance ≥ 90, accessibility ≥ 90
  - **Done when:**
    - [ ] All 3 routes pass thresholds in CI
    - [ ] CI fails below threshold
  - **Prior art:** `@lhci/cli` LHCI server or temporary storage; GitHub Actions Lighthouse action
  - **Status:** `[PENDING]`
  - **Notes:**

#### Milestone 6 Verification
- [ ] All M6 tasks marked [COMPLETE]
- [ ] Animations play at ≥ 60fps (manual verification)
- [ ] All animations suppressed with `prefers-reduced-motion: reduce`
- [ ] CI SPDX, axe-core, and Lighthouse gates passing on main branch

**Milestone completed on:** PENDING

---

## Traceability Matrix

> All 35 PRD Must Have / Should Have stories mapped. No gaps detected.

| PRD Story | Title | Priority | Tasks | Covered |
|-----------|-------|----------|-------|---------|
| E1-S1 | WCAG audit | Must Have | M1-T01 | ✅ |
| E1-S2 | @theme tokens | Must Have | M1-T02 | ✅ |
| E1-S3 | Outfit typography | Must Have | M1-T02 | ✅ |
| E1-S4 | Button component | Must Have | M1-T03 | ✅ |
| E1-S5 | Card component | Must Have | M1-T04 | ✅ |
| E2-S1 | PIN entry | Must Have | M2-T01 | ✅ |
| E2-S2 | Lobby screen | Must Have | M2-T02 | ✅ |
| E2-S3 | Question screen | Must Have | M2-T02 | ✅ |
| E2-S4 | Player leaderboard | Must Have | M2-T02 | ✅ |
| E2-S5 | Player results | Must Have | M2-T02 | ✅ |
| E2-S6 | Disconnect/reconnect | Must Have | M2-T01, M2-T03 | ✅ |
| E3-S1 | Host lobby | Must Have | M2-T04 | ✅ |
| E3-S2 | Host question display | Must Have | M2-T05 | ✅ |
| E3-S3 | Host answer tally | Must Have | M2-T05, M4-T07 | ✅ |
| E3-S4 | Host leaderboard | Must Have | M2-T06 | ✅ |
| E3-S5 | Winner screen | Must Have | M2-T06 | ✅ |
| E4-S1 | Global dark base | Must Have | M1-T02 | ✅ |
| E4-S2 | Navigation | Must Have | M3-T01 | ✅ |
| E4-S3 | Homepage | Must Have | M3-T02 | ✅ |
| E5-S1 | Editor layout | Should Have | M5-T01 | ✅ |
| E5-S2 | MC question card | Should Have | M5-T02 | ✅ |
| E5-S3 | Quiz settings form | Should Have | M5-T02 | ✅ |
| E5-S4 | Question type menu | Should Have | M5-T02 | ✅ |
| E6-S1 | Answer flash animation | Should Have | M6-T01 | ✅ |
| E6-S2 | Score animation | Should Have | M6-T02 | ✅ |
| E6-S3 | Leaderboard animation | Should Have | M6-T03 | ✅ |
| E6-S4 | prefers-reduced-motion | Must Have | M1-T05 | ✅ |
| E7-S1 | Dashboard | Should Have | M5-T03 | ✅ |
| E7-S2 | Results summary | Should Have | M5-T04 | ✅ |
| E7-S3 | Profile/settings | Should Have | M5-T04 | ✅ |
| E8-S1 | Open-ended backend | Must Have | M4-T01, M4-T02 | ✅ |
| E8-S2 | LLM evaluation | Must Have | M4-T03, M4-T04, M4-T05 | ✅ |
| E8-S3 | Player text input | Must Have | M4-T06 | ✅ |
| E8-S4 | Host verdict display | Must Have | M4-T07 | ✅ |
| E8-S5 | Manual review fallback | Must Have | M4-T04, M4-T07 | ✅ |

**Gaps detected:** 0 ✅

---

## NFR Constraint Checklist

| NFR ID | Category | Requirement | Target | Task(s) | Testing Approach | Addressed |
|--------|----------|-------------|--------|---------|-----------------|-----------|
| NFR-P01 | Performance | Player flow page transitions (mobile) | p95 < 2s on 3G | M6-T06 | Lighthouse CI mobile simulation | ✅ |
| NFR-P02 | Performance | E2E open-ended verdict (submit→display) | p95 < 5s | M4-T04 | Socket event timing test in test game | ✅ |
| NFR-P03 | Performance | Design token propagation uniformity | All components at reload | M1-T02 | Vitest CSS content test + visual regression | ✅ |
| NFR-P04 | Performance | Animation frame rate | ≥ 60fps mid-range mobile | M6-T01, M6-T02, M6-T03 | DevTools Performance panel (manual) | ✅ |
| NFR-T01 | Throughput | Concurrent players per session | 50 players | M2 (game loop preserved) | `simulate_players.py` existing load test | ✅ |
| NFR-T02 | Throughput | LiteLLM concurrent evaluation queue | 50 sequential calls/window | M4-T04 | Timing test in dev environment | ✅ |
| NFR-A01 | Availability | 5 critical paths pass CI per PR | 100% pass rate | All milestones + NFR-BC01-08 guard | Existing test suite + new regression tests | ✅ |
| NFR-A02 | Reliability | LLM failure must not crash game | 100% fallback | M4-T04 (circuit-breaker) | Integration test: mock LLM down | ✅ |
| NFR-A03 | Reliability | All error states have UI feedback | 100% error paths | M2-T01, M2-T03, M4-T06, M4-T07 | Manual QA checklist per milestone | ✅ |
| NFR-BC01–BC08 | Backward Compat | All 8 critical paths must not regress | 100% | M0-T03, M2, M5-T01 (regression guard) | `test_server.py` + `test_auth.py` after each milestone | ✅ |
| WCAG AA | Accessibility | 4.5:1 contrast ratio (normal text) | All text/bg combos | M1-T01 (audit gate), M6-T05 (CI scan) | axe-core CI + manual audit | ✅ |
| Motion | Accessibility | `prefers-reduced-motion` support | All animations suppressed | M1-T05, all animation tasks | Playwright media query test | ✅ |
| SPDX | Compliance | MPL-2.0 headers on all modified files | 100% coverage | M6-T04 (CI gate) | REUSE `lint` in CI | ✅ |
| LLM Security | Security | LLM API key in env var only | No hardcoded keys | M4-T03 (env config), NEVER rule in architecture.md | Code review grep | ✅ |

---

## Active ADR Constraints

| ADR | Decision | Developer MUST | Developer MUST NOT |
|-----|----------|----------------|-------------------|
| ADR-001 | Replace ormar with SQLModel | Use `SQLModel` + `table=True` for all DB models; use `async_sessionmaker` + `get_session()` Depends; use `select()` for queries | Use `ormar.Model`, `ormar.UUID`, or any `ormar` import anywhere in `classquiz/` |
| ADR-002 | LiteLLM gateway | Import `litellm` only in `classquiz/llm/__init__.py`; configure via `LITELLM_MODEL` env var; use `acompletion` (async; catch all exceptions → `LLMUnavailableError`) | Hardcode LLM API keys; call `litellm.completion` (sync); import LiteLLM in router files |
| ADR-003 | Design tokens in @theme | Define all colour/font/shadow tokens in `@theme {}` block in `app.css`; reference via utility classes | Create `tailwind.config.js`; hardcode hex values in component `<style>` or `class` attributes; use `theme()` function |
| ADR-004 | Svelte 4→5 Runes interleave | Migrate each component to Runes **before or alongside** redesign; use `$props()`, `$state()`, `$derived()` | Leave components half-migrated (Svelte 4 `export let` mixed with Runes in same file); do big-bang migration of all components at once |
| ADR-005 | MAX_WORKERS=1 socket constraint | Keep `MAX_WORKERS=1` in socket server; document in comments | Set `MAX_WORKERS` > 1 without implementing Redis socket adapter; any implicit assumption of stateless socket server |
| ADR-006 | Prometheus + Grafana | Mount `/metrics` endpoint via `prometheus-fastapi-instrumentator`; add LLM metric counters; provision `grafana/dashboards/partyquiz.json` | Remove or skip metrics instrumentation in `classquiz/llm/`; expose metrics without auth (acceptable — same-host only) |

---

## Roadmap Articles in Effect

| Article | Name | Enforced | Concrete Constraint on Implementation |
|---------|------|----------|--------------------------------------|
| I | Sequential Phase Integrity | Always | Phases cannot be skipped; all specs approved before coding begins ✅ |
| II | Template Compliance | Always | All spec artifacts use templates; `TODO.md` uses `.jumpstart/templates/todo.md` |
| III | Test-First Development | **false** (config: `test_drive_mandate: false`) | Write tests before or alongside code; no Red Phase gate required; acceptance criteria must each map to at least one test |
| IV | Upstream Traceability / Power Inversion | Always | Specs are source of truth; no new tasks added to TODO.md without updating spec first; no silent code-only changes |
| V | Human Gate Authority | Always | Phase 4 complete only upon human approval of final output |
| VI | Simplicity Gate | true | Implementation adds `classquiz/llm/` (1 new dir) and `prometheus/`, `grafana/` (infra dirs) — within 3-dir limit for source code |
| VII | Anti-Abstraction | Enforced | All ADRs exist for abstractions added (LiteLLM module, @theme tokens); no thin wrappers without ADR |
| VIII | Multi-Layer Testing | Enforced | Schema + handoff contract + unit/integration tests; adversarial optional (standard profile) |
| IX | Specialized Agents | Optional | QA, Refactor, Reviewer agents may be invoked at milestone boundaries (standard profile) |
| X | Workflow Orchestration | Always | State persisted to `.jumpstart/state/state.json`; human-in-the-loop checkpoints at high-impact decisions |
| XI | Project Memory | Always | Insights file continuously updated; deviations logged with original spec text + actual implementation |
| XII | Spec Authoring Quality | Enforced | Six core areas covered in architecture.md ✅; context scoping active (`config: true`) |

---

## Agent Permissions

| Action Category | Allowed | Forbidden |
|----------------|---------|-----------|
| **File Read** | Any file in the repository | — |
| **File Create/Edit** | `classquiz/**`, `frontend/src/**`, `migrations/**`, `prometheus/`, `grafana/`, `docker-compose.yml`, `.env.example`, `Pipfile`, `frontend/package.json`, `TODO.md`, `README.md`, `.github/workflows/**` | `.jumpstart/agents/*.md`, `.jumpstart/templates/*.md`, `.jumpstart/roadmap.md`, `specs/architecture.md` (content), `specs/prd.md` |
| **Run Commands** | `pytest`, `pnpm test`, `pnpm run check`, `alembic upgrade/revision/check`, `docker compose up`, linter, formatter, `git tag` (for M0-T01) | `git push`, deployment to production, `alembic downgrade` without flagging |
| **Architecture** | Follow `specs/architecture.md` as-is | Change tech stack, add components not in architecture, alter API contracts, change data model beyond what M4-T01 specifies |
| **Dependencies** | Add `sqlmodel`, `litellm`, `prometheus-fastapi-instrumentator`, `@fontsource/outfit`, `@axe-core/playwright`, `@lhci/cli` (all in architecture.md) | Add new dependencies not in architecture without flagging as deviation |
| **Specs** | Read all; update `specs/implementation-plan.md` task status; update `specs/insights/implementation-plan-insights.md` | Modify PRD AC, architecture design, challenger brief |

---

## Progress Summary

| Metric | Value |
|--------|-------|
| Total Milestones | 7 (M0–M6) |
| Milestones Complete | 0 |
| Total Tasks | 37 |
| Tasks Complete | 2 |
| Tasks In Progress | 0 |
| Tasks Blocked | 0 |
| Tests Written | 0 |
| Tests Passing | 0 |
| Deviations Logged | 1 |
| NEEDS CLARIFICATION Items | 0 |
| Last Updated | 2026-02-24 (M0-T02 ✅ — ormar→SQLModel rewrite complete) |

---

## Validation Checks (All Passed ✅)

1. ✅ Every Must Have story has at least one task (35/35 stories covered, 0 gaps)
2. ✅ No circular dependencies in task DAG (M0→M1→M2→M3∥M4∥M5→M6)
3. ✅ All file paths match target directory structure
4. ✅ All NFRs have at least one task addressing them (14/14 NFRs mapped)
5. ✅ All technologies in tasks appear in Tech Manifest (28 entries)
6. ✅ All tasks with API endpoints + socket events have error handling enumerated
7. ✅ All "Done when" criteria are verifiable by command or file inspection
8. ✅ Data layer declared (PostgreSQL + Redis + JSON column)
9. ✅ 5 canonical code patterns covering all 6 architectural mandates
